<!DOCTYPE html>
<html lang="en">
<head>

<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.11.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.11.0/mapbox-gl.js"></script>

        <style>
            /* MAP */
            body {
                margin: 0;
                padding: 0;
            }

            #map {
                position: absolute;
                top: 0;
                bottom: 0;
                width: 100%;
            }
        </style>

        <style>
            /* MAP POPUPS */
            /* Style for map popups */
            .mapboxgl-popup-content {
                pointer-events: auto;
                border-radius: 4px;
                box-shadow: none;
                padding: 12px 16px;
                color: #161616;
                background-color: #fff;
            }

            /* Style for popup bottom arrow color */
            .mapboxgl-popup-anchor-bottom .mapboxgl-popup-tip {
                border-top-color: #fff;
            }
        </style>

        <style>
            /* MODAL POPUP  STYLES ---- CAN OVERIDE WITH WEBFLOW */
            .locations-map_wrapper {
                display: none;
                /* Initially hide the wrapper.  The JS will show it. */
                /* Add styling for your side panel, e.g., */
                position: fixed;
                top: 0;
                right: 0;
                width: 300px; /* OVER WRITTEN */
                height: 100%; /* OVER WRITTEN */
                padding: 20px; /* OVER WRITTEN */
                z-index: 10; /* OVER WRITTEN */
                overflow-y: auto; /* OVER WRITTEN */
            }

            .locations-map_wrapper.is--show {
                display: block;
                /* Show the wrapper */
            }



            .locations-map_item {
                display: none;
                /* Initially hide each item */
                margin-bottom: 20px;
            }
            .locations-map_item.is--show {
                display: block;
            }

            


            .close-block {
                cursor: pointer;
                position: absolute;
                top: 10px; /* OVER WRITTEN */
                right: 10px; /* OVER WRITTEN */
                font-size: 20px; /* OVER WRITTEN */
            }

            .location-item {
                display: none;
                /* Hide the individual location items */
            }
        </style>
</head>

<body>

    <script src="https://cdn.jsdelivr.net/gh/jscastro76/threebox@v.2.2.2/dist/threebox.min.js" type="text/javascript"></script>

    <link href="https://cdn.jsdelivr.net/gh/jscastro76/threebox@v.2.2.2/dist/threebox.css" rel="stylesheet">


    <!-- THREEBOX -->

       <script> /*INITIALIZE MAP + CMS + CLICKING INTERACTIONS*/
            //remove map wrapper
            $(".locations-map_wrapper").removeClass("is--show");

            // create empty locations geojson object... initialize as empty to put shit in there
            let mapLocations = {
                type: "FeatureCollection",
                features: [],
            };

            // Once a mapLocation item is selected, get in here!!!
            let selectedMapLocations = [];

            // initialize mapbox
            mapboxgl.accessToken = 'pk.eyJ1IjoiZ3Jpc2ZhYXMiLCJhIjoiY21iemNhd3FmMXdqaDJtb2o4ejRibTNseSJ9.7SGZ6pBZdjVIAqKi0pOi7g';

            const map = new mapboxgl.Map({
                style: 'mapbox://styles/grisfaas/cmc3lhhwc00wr01sp07f00mjr',
                container: 'map', // container ID
                center: [-114.05500, 51.02000], // starting position [lng, lat]. Note that lat must be set between -90 and 90
                bearing: 0,
                pitch: 35,
                zoom: 10, // starting zoom
                antialias: true, // THREEBOX create the gl context with MSAA antialiasing, so custom layers are antialiased
                show3dObjects: false // turn off Mapbox 3D buildings

            });

            //-----------------------------------------------------------
            // Adjust zoom of map for mobile and desktop
            let mq = window.matchMedia("(min-width: 480px)");
            if (mq.matches) {
                map.setZoom(10); //set map zoom level for desktop size
            } else {
                map.setZoom(10); //set map zoom level for mobile size
            }

            // Add zoom and rotation controls to the map.
            map.addControl(new mapboxgl.NavigationControl());


            //------------------------[CMS]-----------------------------------SEE THIS AREA FOR POINTS IN 3D SPACE
            // Get cms items
            let listLocations = document.getElementById("location-list").childNodes;

            // For each colleciton item, grab hidden fields and convert to geojson proerty
            function getGeoData() {
                listLocations.forEach(function (location, i) {
                    console.log(location);
                    let locationLat = location.querySelector("#locationLatitude").value;
                    let locationLong = location.querySelector("#locationLongitude").value;
                    let locationInfo = location.querySelector(".locations-map_card").innerHTML;
                    let coordinates = [locationLong, locationLat];
                    let locationID = location.querySelector("#locationID").value;
                    //add array ID
                    let arrayID = (i + 1) - 1;
                    let geoData = {
                        type: "Feature",
                        geometry: {
                            type: "Point",
                            coordinates: coordinates,
                        },
                        properties: {
                            id: locationID,
                            description: locationInfo,
                            arrayID: arrayID,
                        },

                    };

                    if (mapLocations.features.includes(geoData) === false) {
                        mapLocations.features.push(geoData);
                    }
                });
                console.log(mapLocations);
            }

            // Invoke function --- GET THE DATA BAYBE!
            getGeoData();

            // define mapping function to be invoked later
            function addMapPoints() {
                /* Add the data to your map as a layer */
                map.addLayer({
                    id: "locations",
                    type: "circle", // !!!!!!!!!!!!!!!!!!! This can be html markers with the image + border
                    /* Add a GeoJSON source containing place coordinates and information. */
                    source: {
                        type: "geojson",
                        data: mapLocations,
                    },
                    paint: {
                        "circle-radius": 8,
                        "circle-stroke-width": 1,
                        "circle-color": "#5FC5C2",
                        "circle-opacity": 1,
                        "circle-stroke-color": "#777879",
                    },
                });

                // open a popup with the correct location 
                function addPopup(e) {
                    // Copy coordinates array.
                    const coordinates = e.features[0].geometry.coordinates.slice();
                    const description = e.features[0].properties.description;

                    // Ensure that if the map is zoomed out such that multiple
                    // copies of the feature are visible, the popup appears
                    // over the copy being pointed to.
                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    new mapboxgl.Popup().setLngLat(coordinates).setHTML(description).addTo(map);
                }

                // When a click event occurs on a feature in the places layer, open a popup at the
                // location of the feature, with description HTML from its properties.
                map.on("click", "locations", (e) => {
                    //find ID of collection item in array
                    const ID = e.features[0].properties.arrayID;
                    //add popup 
                    addPopup(e);
                    //show webflow Collection module
                    $(".locations-map_wrapper").addClass("is--show");

                    //Check if an item is currently there
                    if ($(".locations-map_item.is--show").length) {
                        $(".locations-map_item").removeClass("is--show");
                    }
                    //find collection item by array ID and show it
                    $(".locations-map_item").eq(ID).addClass("is--show");
                });

                // -----------------------------------------------------------------------EASING
                const easingFunctions = {
                    // start slow and gradually increase speed
                    easeInCubic: function (t) {
                        return t * t * t;
                    },
                    // start fast with a long, slow wind-down
                    easeOutQuint: function (t) {
                        return 1 - Math.pow(1 - t, 5);
                    },
                    // slow start and finish with fast middle
                    easeInOutCirc: function (t) {
                        return t < 0.5
                            ? (1 - Math.sqrt(1 - Math.pow(2 * t, 2))) / 2
                            : (Math.sqrt(1 - Math.pow(-2 * t + 2, 2)) + 1) / 2;
                    },
                    // fast start with a "bounce" at the end
                    easeOutBounce: function (t) {
                        const n1 = 7.5625;
                        const d1 = 2.75;

                        if (t < 1 / d1) {
                            return n1 * t * t;
                        } else if (t < 2 / d1) {
                            return n1 * (t -= 1.5 / d1) * t + 0.75;
                        } else if (t < 2.5 / d1) {
                            return n1 * (t -= 2.25 / d1) * t + 0.9375;
                        } else {
                            return n1 * (t -= 2.625 / d1) * t + 0.984375;
                        }
                    }
                };

                // Center the map on the coordinates of any clicked circle from the 'locations' layer.
                map.on("click", "locations", (e) => {
                    map.flyTo({
                        center: e.features[0].geometry.coordinates,
                        speed: 0.5,
                        curve: 2,
                        duration: 1000,
                        essential: true, // this animation is considered essential with respect to prefers-reduced-motion
                        easeOutQuint(t) {
                            return t;
                        },
                    });
                });

                // Change the cursor to a pointer when the mouse is over the 'locations' layer.
                map.on("mouseenter", "locations", () => {
                    map.getCanvas().style.cursor = "pointer";
                });

                // Change it back to a pointer when it leaves.
                map.on("mouseleave", "locations", () => {
                    map.getCanvas().style.cursor = "";
                });
            }

            //When map is loaded initialize with data
            map.on("load", function (e) {
                addMapPoints();
            });

            //close side nav with button
            $(".close-block").click(function () {
                $(".locations-map_wrapper").removeClass("is--show");
            });


            //-------------------------hover stuff-------------------------
            //set hover popup
            const popup = new mapboxgl.Popup({
                closeButton: false,
                closeOnClick: false
            });
            // When a click event occurs on a feature in the places layer, open a popup at the
            // location of the feature, with description HTML from its properties.
            map.on('mouseenter', 'locations', (e) => {
                // Change the cursor style as a UI indicator.
                map.getCanvas().style.cursor = 'pointer';

                // Copy coordinates array.
                const coordinates = e.features[0].geometry.coordinates.slice();
                const description = e.features[0].properties.description;

                // Ensure that if the map is zoomed out such that multiple
                // copies of the feature are visible, the popup appears
                // over the copy being pointed to.
                while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                }

                // Populate the popup and set its coordinates
                // based on the feature found.
                popup.setLngLat(coordinates).setHTML(description).addTo(map);
            });

            map.on('mouseleave', 'locations', () => {
                map.getCanvas().style.cursor = '';
                popup.remove();
            });

        </script>
        <script> 
            // ------------------------------------------------------ 3D THREEBOX ---------------------------------------------------------
            // eslint-disable-next-line no-undef
            const tb = (window.tb = new Threebox(
                map,
                map.getCanvas().getContext('webgl'),
                {
                    defaultLights: true
                }
            ));

                map.on('style.load', () => {
                map.addLayer({
                    id: 'custom-threebox-model',
                    type: 'custom',
                    renderingMode: '3d',
                    onAdd: function () {
                        const scale = 3.2;
                        const options = {
                            obj: 'https://thanakritgonggraikij.github.io/faasGIS3D/windsor.mtl', //3D OBJECT HERE
                            type: 'mtl',
                            scale: { x: scale, y: scale, z: 2.7 },
                            units: 'meters',
                            rotation: { x: 90, y: -90, z: 0 }
                        };

                        tb.loadObj(options, (model) => {
                            model.setCoords([-73.976799, 40.754145]);
                            model.setRotation({ x: 0, y: 0, z: 241 });
                            tb.add(model);
                        });
                    },

                    render: function () {
                        tb.update();
                    }
                });
            });
        </script>
</body>
</html>